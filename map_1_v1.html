<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Map</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@300;400;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Albert Sans", "Albert Sans Placeholder", sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .mapboxgl-popup-content {
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.06);
            background: rgba(255, 255, 255, 0.90);
            padding: 15px;
            color: #23303a;
            font-family: "Albert Sans", "Albert Sans Placeholder", sans-serif !important;
        }

        .mapboxgl-popup-close-button {
            color: #0b7285;
            opacity: 0.9;
            font-size: 25px;
            width: 36px;
            height: 36px;
            line-height: 36px;
            border-radius: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: "Albert Sans", "Albert Sans Placeholder", sans-serif !important;
        }

        .popup-header {
            padding-right: 10px;
            color: #0089a8;
            font-size: 23px;
            font-weight: 700;
            margin: 0 0 8px 0;
            line-height: 1.1;
            font-family: "Albert Sans", "Albert Sans Placeholder", sans-serif !important;
        }

        .popup-address {
            color: #6b7b81;
            font-size: 16px;
            margin: 0 0 12px 0;
            font-family: "Albert Sans", "Albert Sans Placeholder", sans-serif !important;
            line-height: 1.4;
        }

        .popup-divider {
            height: 1px;
            background: #e6eef2;
            margin: 12px 0;
            border-radius: 1px;
        }

        .popup-flex {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .popup-flex-item {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            color: #0089a8;
            font-size: 18px;
            font-weight: 700;
            font-family: "Albert Sans", "Albert Sans Placeholder", sans-serif !important;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-family: "Albert Sans", "Albert Sans Placeholder", sans-serif;
        }
    </style>
</head>

<body>
    <div id="loading" class="loading">Loading hospital data...</div>
    <div id="map"></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2VyaHV6IiwiYSI6ImNseXpvc3RlczJpbnIya3FscDU2aHc5d3EifQ.FHtPjde_lqensSHZxqthgw';

        let currentPopup = null;
        let mapFullyLoaded = false;

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [-95.7129, 37.0902],
            zoom: 4,
            projection: 'mercator'
        });

        // Add cache-busting to Google Sheets URL
        function getCsvUrl() {
            const baseUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvmr4_y0GFuI1lUZ-OHA5NUPga4V0gVEwpLYv_CW12LtqQ6DAb97ZbkP1Y-cBWS7rb-COy_6Ejmc89/pub?output=csv';
            return `${baseUrl}&timestamp=${Date.now()}`; // Cache busting
        }

        function createGeoJSON(hospitals) {
            console.log('Total hospitals in CSV:', hospitals.length);
            
            const features = hospitals
                .filter(hospital => {
                    const hasCoords = hospital.lat && hospital.lon && 
                                    !isNaN(parseFloat(hospital.lat)) && 
                                    !isNaN(parseFloat(hospital.lon));
                    if (!hasCoords) {
                        console.warn('Skipping hospital without valid coordinates:', hospital.Hospitals || 'Unknown');
                    }
                    return hasCoords;
                })
                .map(hospital => ({
                    type: 'Feature',
                    properties: {
                        name: hospital.Hospitals || 'Unknown Hospital',
                        address: hospital.Address || '',
                        goKarts: hospital['Go Karts'] || '0',
                        kidsSupported: hospital['Kids Supported'] || '0',
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: [parseFloat(hospital.lon), parseFloat(hospital.lat)]
                    }
                }));

            console.log('Valid hospitals with coordinates:', features.length);
            
            return {
                type: 'FeatureCollection',
                features: features
            };
        }

        function createPopupContent(properties) {
            const goKarts = properties.goKarts || '—';
            return `
                <div>
                    <div class="popup-header">${properties.name}</div>
                    <div class="popup-address">${properties.address || ''}</div>

                    <div class="popup-divider"></div>

                    <div class="popup-flex">
                        <div class="popup-flex-item">
                            <div class="label">GO Karts</div>
                            <div class="value" style="min-width:26px;text-align:center;color:#f9af7c">${goKarts}</div>
                        </div>
                        <div class="popup-flex-item">
                            <div class="label">Player 2 Active</div>
                            <div class="value">
                              <svg display="block" role="presentation" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="26" height="26">
                                <path d="M 5 10 L 8.5 13.5 L 15 7 M 20 10 C 20 15.523 15.523 20 10 20 C 4.477 20 0 15.523 0 10 C 0 4.477 4.477 0 10 0 C 15.523 0 20 4.477 20 10 Z" 
                                        fill="none" 
                                        stroke="#f9af7c" 
                                        stroke-width="2" 
                                        stroke-linecap="round" 
                                        stroke-linejoin="round" 
                                        transform="translate(2 2)"/>
                                </svg>
                            </div>
                        </div>
                        <div class="popup-flex-item">
                            <div class="label">Save Point</div>
                            <div class="value">
                                <svg display="block" role="presentation" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="26" height="26">
                                    <path d="M 14 6 L 10 10 M 10 10 L 6 14 M 10 10 L 6 6 M 10 10 L 14 14 M 20 10 C 20 15.523 15.523 20 10 20 C 4.477 20 0 15.523 0 10 C 0 4.477 4.477 0 10 0 C 15.523 0 20 4.477 20 10 Z" 
                                            fill="none" 
                                            stroke="#f9af7c" 
                                            stroke-width="2" 
                                            stroke-linecap="round" 
                                            stroke-linejoin="round" 
                                            transform="translate(2 2)"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Retry logic for fetching CSV
        async function fetchWithRetry(url, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    console.log(`Attempt ${i + 1} to fetch CSV...`);
                    const response = await d3.csv(url);
                    console.log('CSV fetched successfully');
                    return response;
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
        }

        async function loadHospitalData() {
            try {
                document.getElementById('loading').innerHTML = 'Fetching hospital data...';
                
                const response = await fetchWithRetry(getCsvUrl());

                if (!response || response.length === 0) {
                    throw new Error('No data received from CSV');
                }

                document.getElementById('loading').innerHTML = 'Processing data...';
                const geojsonData = createGeoJSON(response);

                if (geojsonData.features.length === 0) {
                    throw new Error('No valid hospital locations found in CSV');
                }

                document.getElementById('loading').innerHTML = 'Adding markers to map...';

                // Ensure map is ready before adding source
                if (!map.isStyleLoaded()) {
                    console.log('Waiting for style to load...');
                    await new Promise(resolve => map.once('idle', resolve));
                }

                // Remove existing source and layers if they exist (for reloading)
                if (map.getSource('hospitals')) {
                    if (map.getLayer('hospital-points-hover')) map.removeLayer('hospital-points-hover');
                    if (map.getLayer('hospital-points')) map.removeLayer('hospital-points');
                    map.removeSource('hospitals');
                }

                // Add source
                map.addSource('hospitals', {
                    type: 'geojson',
                    data: geojsonData
                });

                // Add circle layer for points
                map.addLayer({
                    id: 'hospital-points',
                    type: 'circle',
                    source: 'hospitals',
                    paint: {
                        'circle-radius': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            7, 6,
                            15, 12
                        ],
                        'circle-color': '#0089a8',
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#ffffff',
                        'circle-opacity': 0.8
                    }
                });

                // Add hover layer
                map.addLayer({
                    id: 'hospital-points-hover',
                    type: 'circle',
                    source: 'hospitals',
                    paint: {
                        'circle-radius': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            5, 6,
                            15, 16
                        ],
                        'circle-color': '#f9af7c',
                        'circle-stroke-width': 3,
                        'circle-stroke-color': '#ffffff',
                        'circle-opacity': 0
                    },
                    filter: ['==', ['get', 'name'], '']
                });

                // Click handler
                map.on('click', 'hospital-points', (e) => {
                    if (!e.features || e.features.length === 0) return;
                    
                    const coordinates = e.features[0].geometry.coordinates.slice();
                    const properties = e.features[0].properties;

                    if (currentPopup) {
                        currentPopup.remove();
                        currentPopup = null;
                    }

                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    map.easeTo({ center: coordinates });

                    currentPopup = new mapboxgl.Popup({
                        offset: 10,
                        closeButton: true,
                        closeOnClick: false,
                        maxWidth: '265px'
                    })
                        .setLngLat(coordinates)
                        .setHTML(createPopupContent(properties))
                        .addTo(map);

                    currentPopup.on('close', () => {
                        currentPopup = null;
                    });
                });

                // Hover effects
                map.on('mouseenter', 'hospital-points', (e) => {
                    map.getCanvas().style.cursor = 'pointer';
                    if (e.features && e.features.length > 0) {
                        map.setFilter('hospital-points-hover', ['==', ['get', 'name'], e.features[0].properties.name]);
                        map.setPaintProperty('hospital-points-hover', 'circle-opacity', 1);
                    }
                });

                map.on('mouseleave', 'hospital-points', () => {
                    map.getCanvas().style.cursor = '';
                    map.setPaintProperty('hospital-points-hover', 'circle-opacity', 0);
                    map.setFilter('hospital-points-hover', ['==', ['get', 'name'], '']);
                });

                // Fit bounds
                if (geojsonData.features.length > 0) {
                    const bounds = new mapboxgl.LngLatBounds();
                    geojsonData.features.forEach(feature => {
                        bounds.extend(feature.geometry.coordinates);
                    });
                    map.fitBounds(bounds, { padding: 50 });
                }

                document.getElementById('loading').style.display = 'none';
                console.log('✅ Map loaded successfully with', geojsonData.features.length, 'hospitals');

            } catch (error) {
                console.error('❌ Error loading data:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #d32f2f;">
                        <strong>Error loading data</strong><br>
                        ${error.message}<br>
                        <button onclick="location.reload()" style="margin-top:10px;padding:8px 16px;cursor:pointer;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function applyCustomStyle() {
            const waterColor = '#ffffff';
            const landColor = '#d2e3e8';

            if (!map || !map.isStyleLoaded()) {
                console.warn('Style not loaded yet');
                return;
            }

            const layers = map.getStyle().layers || [];

            layers.forEach(layer => {
                const id = (layer.id || '').toLowerCase();
                try {
                    if (id.includes('water') || id.includes('ocean') || id.includes('sea') || id.includes('river') || id.includes('waterway')) {
                        if (layer.type === 'fill') map.setPaintProperty(layer.id, 'fill-color', waterColor);
                        else if (layer.type === 'line') map.setPaintProperty(layer.id, 'line-color', waterColor);
                        else if (layer.type === 'background') map.setPaintProperty(layer.id, 'background-color', waterColor);
                    }
                    else if (layer.type === 'background' || id.includes('land') || id.includes('landuse') || id.includes('park') || id.includes('grass')) {
                        if (layer.type === 'fill') map.setPaintProperty(layer.id, 'fill-color', landColor);
                        else if (layer.type === 'background') map.setPaintProperty(layer.id, 'background-color', landColor);
                    }

                    if (id.includes('admin-2') || (id.includes('admin') && id.includes('2'))) {
                        try { map.setLayoutProperty(layer.id, 'visibility', 'none'); } catch (e) { }
                    }

                    if (id.includes('admin-1') || (id.includes('admin') && id.includes('1'))) {
                        try { map.setLayoutProperty(layer.id, 'visibility', 'none'); } catch (e) { }
                    }

                    if (id.includes('admin-0')) {
                        if (layer.type === 'line') {
                            try { map.setPaintProperty(layer.id, 'line-color', '#ffffff'); } catch (e) { }
                            try { map.setPaintProperty(layer.id, 'line-width', ['interpolate', ['linear'], ['zoom'], 0, 0.4, 5, 0.6, 10, 1]); } catch (e) { }
                        }
                    }

                    if (layer.type === 'symbol') {
                        try { map.setLayoutProperty(layer.id, 'visibility', 'none'); } catch (e) { }
                    }
                } catch (e) {
                    // Ignore
                }
            });
            
            console.log('✅ Custom styling applied');
        }

        // Wait for map to be fully loaded before loading data
        map.on('load', () => {
            console.log('Map load event fired');
            applyCustomStyle();
            // Wait a bit to ensure style is fully applied
            setTimeout(() => {
                mapFullyLoaded = true;
                loadHospitalData();
            }, 100);
        });

        // Fallback if load doesn't fire
        setTimeout(() => {
            if (!mapFullyLoaded) {
                console.warn('Load event timeout - forcing data load');
                mapFullyLoaded = true;
                applyCustomStyle();
                loadHospitalData();
            }
        }, 5000);

        const navigation = new mapboxgl.NavigationControl({
            showCompass: false,
            showZoom: true
        });
        map.addControl(navigation, 'bottom-left');
    </script>
</body>

</html>
